<!DOCTYPE html>
<html lang="en">
<head>
  <meta property="og:image" content="https://corvid-agent.github.io/morse-code/docs/preview.png">
  <meta property="og:image:width" content="1280">
  <meta property="og:image:height" content="640">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morse Code Translator</title>
<meta name="description" content="Real-time Morse code translator with audio playback, visual animation, and adjustable speed.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<link href="https://fontlibrary.org/face/dogica" rel="stylesheet" type="text/css">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

  :root{
    --bg:#08080f;
    --card:#12121a;
    --card-hover:#1a1a28;
    --text:#e8e8f0;
    --text-dim:#9898a8;
    --accent:#8b5cf6;
    --accent-glow:rgba(139,92,246,.25);
    --secondary:#06b6d4;
    --secondary-glow:rgba(6,182,212,.2);
    --border:#2a2a3a;
    --radius:8px;
    --font-pixel:'DogicaPixelRegular','Press Start 2P',monospace;
    --font-body:'Press Start 2P',monospace;
    --transition:0.2s ease;
  }

  @media(prefers-reduced-motion:reduce){
    *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}
  }

  html{font-size:16px;scroll-behavior:smooth}
  body{
    font-family:var(--font-body);
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
    line-height:1.6;
    font-size:0.875rem;
    -webkit-font-smoothing:antialiased;
  }

  :focus-visible{
    outline:2px solid var(--accent);
    outline-offset:2px;
    border-radius:2px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:var(--bg)}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--accent)}

  /* Layout */
  .container{max-width:960px;margin:0 auto;padding:1.5rem 1rem}

  /* Header */
  header{text-align:center;padding:2rem 0 1.5rem}
  header h1{
    font-family:var(--font-pixel);
    font-size:clamp(1.25rem,4vw,2rem);
    color:var(--accent);
    letter-spacing:2px;
    text-shadow:0 0 20px var(--accent-glow);
    margin-bottom:0.5rem;
  }
  header p{
    font-size:0.75rem;
    color:var(--text-dim);
    letter-spacing:1px;
  }

  /* Panels */
  .panels{
    display:grid;
    grid-template-columns:1fr auto 1fr;
    gap:0;
    align-items:stretch;
    margin-bottom:1rem;
  }
  @media(max-width:700px){
    .panels{grid-template-columns:1fr;gap:0}
    .swap-col{order:1}
    .panel:first-child{order:0}
    .panel:last-child{order:2}
  }

  .panel{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1rem;
    display:flex;
    flex-direction:column;
  }
  .panel-label{
    font-family:var(--font-pixel);
    font-size:0.625rem;
    color:var(--secondary);
    text-transform:uppercase;
    letter-spacing:2px;
    margin-bottom:0.75rem;
    display:flex;
    align-items:center;
    gap:0.5rem;
  }
  .panel-label .icon{font-size:0.875rem}

  textarea{
    flex:1;
    width:100%;
    min-height:140px;
    background:var(--bg);
    color:var(--text);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:0.75rem;
    font-family:var(--font-body);
    font-size:0.875rem;
    line-height:1.8;
    resize:vertical;
    transition:border-color var(--transition);
  }
  textarea::placeholder{color:var(--text-dim);opacity:0.6}
  textarea:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px var(--accent-glow)}

  /* Swap button */
  .swap-col{
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0 0.5rem;
  }
  .swap-btn{
    background:var(--card);
    border:1px solid var(--border);
    color:var(--accent);
    width:40px;
    height:40px;
    border-radius:50%;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.125rem;
    transition:all var(--transition);
  }
  .swap-btn:hover{background:var(--accent);color:var(--bg);border-color:var(--accent)}
  @media(max-width:700px){
    .swap-btn{transform:rotate(90deg);margin:0.5rem auto}
  }

  /* Controls bar */
  .controls{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1rem;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:1rem;
    margin-bottom:1rem;
  }

  .btn{
    font-family:var(--font-pixel);
    font-size:0.625rem;
    padding:0.625rem 1rem;
    border-radius:var(--radius);
    border:1px solid var(--border);
    cursor:pointer;
    transition:all var(--transition);
    display:inline-flex;
    align-items:center;
    gap:0.5rem;
    letter-spacing:1px;
    white-space:nowrap;
  }
  .btn-primary{
    background:var(--accent);
    color:#fff;
    border-color:var(--accent);
  }
  .btn-primary:hover{background:#7c4fe6;box-shadow:0 0 16px var(--accent-glow)}
  .btn-primary:disabled{opacity:0.4;cursor:not-allowed}
  .btn-primary.playing{background:#dc2626;border-color:#dc2626}
  .btn-secondary{
    background:transparent;
    color:var(--text);
  }
  .btn-secondary:hover{background:var(--card-hover);border-color:var(--text-dim)}

  .speed-control{
    display:flex;
    align-items:center;
    gap:0.75rem;
    flex:1;
    min-width:200px;
  }
  .speed-control label{
    font-family:var(--font-pixel);
    font-size:0.5625rem;
    color:var(--text-dim);
    letter-spacing:1px;
    white-space:nowrap;
  }
  .speed-control input[type="range"]{
    flex:1;
    -webkit-appearance:none;
    appearance:none;
    height:6px;
    background:var(--border);
    border-radius:3px;
    outline:none;
  }
  .speed-control input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:16px;height:16px;
    background:var(--accent);
    border-radius:50%;
    cursor:pointer;
    border:2px solid var(--bg);
    box-shadow:0 0 6px var(--accent-glow);
  }
  .speed-control input[type="range"]::-moz-range-thumb{
    width:16px;height:16px;
    background:var(--accent);
    border-radius:50%;
    cursor:pointer;
    border:2px solid var(--bg);
  }
  .speed-val{
    font-family:var(--font-pixel);
    font-size:0.625rem;
    color:var(--accent);
    min-width:3.5em;
    text-align:right;
  }

  /* Visual playback */
  .playback-bar{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1rem;
    margin-bottom:1rem;
    min-height:56px;
    display:flex;
    align-items:center;
    gap:4px;
    flex-wrap:wrap;
    overflow-x:auto;
  }
  .playback-bar:empty::after{
    content:'playback visualization';
    font-family:var(--font-pixel);
    font-size:0.5625rem;
    color:var(--text-dim);
    opacity:0.4;
    letter-spacing:1px;
  }

  .sym{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:28px;
    border-radius:4px;
    background:var(--border);
    transition:background 0.15s,box-shadow 0.15s;
    flex-shrink:0;
  }
  .sym.dot{width:14px}
  .sym.dash{width:36px}
  .sym.letter-gap{width:6px;background:transparent}
  .sym.word-gap{width:18px;background:transparent}
  .sym.active{
    background:var(--accent);
    box-shadow:0 0 12px var(--accent-glow);
  }
  .sym.played{
    background:var(--secondary);
    box-shadow:0 0 8px var(--secondary-glow);
  }

  /* Toast */
  .toast{
    position:fixed;
    bottom:1.5rem;
    left:50%;
    transform:translateX(-50%) translateY(80px);
    background:var(--accent);
    color:#fff;
    font-family:var(--font-pixel);
    font-size:0.5625rem;
    padding:0.625rem 1.25rem;
    border-radius:var(--radius);
    letter-spacing:1px;
    opacity:0;
    transition:all 0.3s ease;
    pointer-events:none;
    z-index:100;
  }
  .toast.show{
    opacity:1;
    transform:translateX(-50%) translateY(0);
  }

  /* Reference chart */
  .reference{margin-bottom:2rem}
  .ref-toggle{
    width:100%;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:0.875rem 1rem;
    color:var(--text);
    font-family:var(--font-pixel);
    font-size:0.625rem;
    letter-spacing:2px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    transition:all var(--transition);
  }
  .ref-toggle:hover{background:var(--card-hover);border-color:var(--text-dim)}
  .ref-toggle .arrow{
    transition:transform 0.3s ease;
    font-size:0.75rem;
  }
  .ref-toggle[aria-expanded="true"] .arrow{transform:rotate(180deg)}

  .ref-grid{
    display:none;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:0.5rem;
    padding:1rem;
    background:var(--card);
    border:1px solid var(--border);
    border-top:none;
    border-radius:0 0 var(--radius) var(--radius);
  }
  .ref-grid.open{display:grid}

  .ref-item{
    display:flex;
    align-items:center;
    gap:0.5rem;
    padding:0.375rem 0.5rem;
    background:var(--bg);
    border-radius:4px;
    border:1px solid transparent;
    transition:border-color var(--transition);
  }
  .ref-item:hover{border-color:var(--border)}
  .ref-char{
    font-family:var(--font-pixel);
    font-size:0.75rem;
    color:var(--accent);
    min-width:1.5em;
    text-align:center;
  }
  .ref-morse{
    font-size:0.75rem;
    color:var(--text-dim);
    letter-spacing:2px;
  }

  /* Footer */
  footer{
    text-align:center;
    padding:1.5rem 0;
    font-size:0.625rem;
    color:var(--text-dim);
    letter-spacing:1px;
    opacity:0.5;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>morse code</h1>
    <p>translator &amp; audio player</p>
  </header>

  <!-- Panels -->
  <div class="panels">
    <div class="panel" id="panel-text">
      <div class="panel-label"><span class="icon" aria-hidden="true">Aa</span> text</div>
      <textarea id="text-input" placeholder="Type your message here..." aria-label="Text input" spellcheck="false"></textarea>
    </div>

    <div class="swap-col">
      <button class="swap-btn" id="swap-btn" aria-label="Swap translation direction" title="Swap direction">&#8644;</button>
    </div>

    <div class="panel" id="panel-morse">
      <div class="panel-label"><span class="icon" aria-hidden="true">.-</span> morse</div>
      <textarea id="morse-input" placeholder="Type dots (.) and dashes (-) ..." aria-label="Morse code input" spellcheck="false"></textarea>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn btn-primary" id="play-btn" aria-label="Play Morse code audio">
      <span id="play-icon">&#9654;</span>
      <span id="play-label">play</span>
    </button>

    <div class="speed-control">
      <label for="speed-slider">wpm</label>
      <input type="range" id="speed-slider" min="5" max="25" step="5" value="15" aria-label="Speed in words per minute">
      <span class="speed-val" id="speed-val" aria-live="polite">15</span>
    </div>

    <button class="btn btn-secondary" id="copy-morse-btn" aria-label="Copy Morse code to clipboard">
      copy morse
    </button>
    <button class="btn btn-secondary" id="copy-text-btn" aria-label="Copy text to clipboard">
      copy text
    </button>
  </div>

  <!-- Playback visualization -->
  <div class="playback-bar" id="playback-bar" aria-label="Morse code playback visualization" role="status"></div>

  <!-- Reference chart -->
  <div class="reference">
    <button class="ref-toggle" id="ref-toggle" aria-expanded="false" aria-controls="ref-grid">
      <span>reference chart</span>
      <span class="arrow" aria-hidden="true">&#9660;</span>
    </button>
    <div class="ref-grid" id="ref-grid" role="region" aria-label="Morse code reference chart"></div>
  </div>

  <footer>corvid-agent / morse-code</footer>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  'use strict';

  // --- Morse code dictionary ---
  const CHAR_TO_MORSE = {
    'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....',
    'I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.',
    'Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-',
    'Y':'-.--','Z':'--..',
    '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-',
    '5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
    '.':'.-.-.-',',':'--..--','?':'..--..','\'':'.----.','!':'-.-.--',
    '/':'-..-.','(':'-.--.',')':'-.--..',':':'---...',';':'-.-.-.',
    '=':'-...-','+':'.-.-.','-':'-....-','_':'..--.-','"':'.-..-.',
    '$':'...-..-','@':'.--.-.','&':'.-...',' ':'/'
  };

  const MORSE_TO_CHAR = {};
  for (const [ch, morse] of Object.entries(CHAR_TO_MORSE)) {
    if (ch !== ' ') MORSE_TO_CHAR[morse] = ch;
  }

  // --- DOM refs ---
  const textInput = document.getElementById('text-input');
  const morseInput = document.getElementById('morse-input');
  const swapBtn = document.getElementById('swap-btn');
  const playBtn = document.getElementById('play-btn');
  const playIcon = document.getElementById('play-icon');
  const playLabel = document.getElementById('play-label');
  const speedSlider = document.getElementById('speed-slider');
  const speedVal = document.getElementById('speed-val');
  const copyMorseBtn = document.getElementById('copy-morse-btn');
  const copyTextBtn = document.getElementById('copy-text-btn');
  const playbackBar = document.getElementById('playback-bar');
  const refToggle = document.getElementById('ref-toggle');
  const refGrid = document.getElementById('ref-grid');
  const toast = document.getElementById('toast');

  // --- State ---
  let direction = 'text-to-morse'; // or 'morse-to-text'
  let isPlaying = false;
  let audioCtx = null;
  let stopRequested = false;
  let activeOscillators = [];

  // --- Conversion ---
  function textToMorse(text) {
    return text.toUpperCase().split('').map(ch => {
      if (ch === ' ') return '/';
      return CHAR_TO_MORSE[ch] || '';
    }).filter(Boolean).join(' ');
  }

  function morseToText(morse) {
    return morse.trim().split(/\s+/).map(code => {
      if (code === '/' || code === '|') return ' ';
      return MORSE_TO_CHAR[code] || '';
    }).join('');
  }

  // --- Real-time translation ---
  textInput.addEventListener('input', function() {
    if (direction === 'text-to-morse') {
      morseInput.value = textToMorse(this.value);
      buildPlaybackSymbols();
    }
  });

  morseInput.addEventListener('input', function() {
    if (direction === 'morse-to-text') {
      textInput.value = morseToText(this.value);
      buildPlaybackSymbols();
    }
  });

  // --- Swap direction ---
  swapBtn.addEventListener('click', function() {
    if (direction === 'text-to-morse') {
      direction = 'morse-to-text';
      textInput.readOnly = true;
      morseInput.readOnly = false;
      textInput.style.opacity = '0.7';
      morseInput.style.opacity = '1';
      morseInput.focus();
    } else {
      direction = 'text-to-morse';
      textInput.readOnly = false;
      morseInput.readOnly = true;
      textInput.style.opacity = '1';
      morseInput.style.opacity = '0.7';
      textInput.focus();
    }
  });

  // Initialize direction
  morseInput.readOnly = true;
  morseInput.style.opacity = '0.7';

  // --- Speed ---
  speedSlider.addEventListener('input', function() {
    speedVal.textContent = this.value;
  });

  function getWPM() {
    return parseInt(speedSlider.value, 10);
  }

  function dotDuration() {
    return 1200 / getWPM();
  }

  // --- Playback visualization ---
  function buildPlaybackSymbols() {
    playbackBar.innerHTML = '';
    const morse = morseInput.value.trim();
    if (!morse) return;

    const tokens = parseMorseTokens(morse);
    tokens.forEach(function(token, i) {
      const el = document.createElement('span');
      el.className = 'sym';
      if (token === '.') {
        el.classList.add('dot');
        el.setAttribute('aria-label', 'dot');
      } else if (token === '-') {
        el.classList.add('dash');
        el.setAttribute('aria-label', 'dash');
      } else if (token === 'letter-gap') {
        el.classList.add('letter-gap');
      } else if (token === 'word-gap') {
        el.classList.add('word-gap');
      }
      el.dataset.index = i;
      playbackBar.appendChild(el);
    });
  }

  function parseMorseTokens(morse) {
    const tokens = [];
    // Split by spaces; '/' or multiple spaces mark word gaps
    const parts = morse.split(' ');
    for (let p = 0; p < parts.length; p++) {
      const part = parts[p];
      if (part === '/' || part === '|' || part === '') {
        // word gap (collapse consecutive slashes/spaces)
        if (tokens.length > 0 && tokens[tokens.length - 1] !== 'word-gap') {
          tokens.push('word-gap');
        }
        continue;
      }
      // letter
      if (tokens.length > 0 && tokens[tokens.length - 1] !== 'word-gap' && tokens[tokens.length - 1] !== 'letter-gap') {
        tokens.push('letter-gap');
      }
      for (const ch of part) {
        if (ch === '.' || ch === '-') {
          tokens.push(ch);
        }
      }
    }
    return tokens;
  }

  // --- Audio playback ---
  function ensureAudioCtx() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function playTone(startTime, duration) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 600;
    gain.gain.setValueAtTime(0, startTime);
    gain.gain.linearRampToValueAtTime(0.5, startTime + 0.005);
    gain.gain.setValueAtTime(0.5, startTime + duration - 0.005);
    gain.gain.linearRampToValueAtTime(0, startTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(startTime);
    osc.stop(startTime + duration);
    activeOscillators.push(osc);
    osc.onended = function() {
      const idx = activeOscillators.indexOf(osc);
      if (idx !== -1) activeOscillators.splice(idx, 1);
    };
  }

  async function playMorse() {
    if (isPlaying) {
      stopRequested = true;
      return;
    }

    const morse = morseInput.value.trim();
    if (!morse) return;

    ensureAudioCtx();
    buildPlaybackSymbols();

    const tokens = parseMorseTokens(morse);
    const dot = dotDuration() / 1000; // seconds
    const symElements = playbackBar.querySelectorAll('.sym');

    isPlaying = true;
    stopRequested = false;
    playBtn.classList.add('playing');
    playIcon.innerHTML = '&#9632;';
    playLabel.textContent = 'stop';

    let currentTime = audioCtx.currentTime + 0.05;
    const schedule = []; // [{time, duration, index}]

    for (let i = 0; i < tokens.length; i++) {
      const token = tokens[i];
      if (token === '.') {
        schedule.push({ time: currentTime, duration: dot, index: i });
        playTone(currentTime, dot);
        currentTime += dot + dot; // symbol + inter-symbol gap
      } else if (token === '-') {
        const dashDur = dot * 3;
        schedule.push({ time: currentTime, duration: dashDur, index: i });
        playTone(currentTime, dashDur);
        currentTime += dashDur + dot;
      } else if (token === 'letter-gap') {
        currentTime += dot * 2; // already have 1 dot from symbol gap, add 2 more = 3 total
      } else if (token === 'word-gap') {
        currentTime += dot * 6; // already have 1 dot from symbol gap, add 6 more = 7 total
      }
    }

    // Animate symbols
    const startWall = performance.now();
    const audioStart = schedule.length > 0 ? schedule[0].time : audioCtx.currentTime;

    function animate() {
      if (stopRequested) {
        finishPlayback(symElements);
        return;
      }

      const now = audioCtx.currentTime;

      for (let s = 0; s < schedule.length; s++) {
        const el = symElements[schedule[s].index];
        if (!el) continue;
        if (now >= schedule[s].time && now < schedule[s].time + schedule[s].duration) {
          el.classList.add('active');
          el.classList.remove('played');
        } else if (now >= schedule[s].time + schedule[s].duration) {
          el.classList.remove('active');
          el.classList.add('played');
        }
      }

      if (now < currentTime) {
        requestAnimationFrame(animate);
      } else {
        // Mark remaining as played
        symElements.forEach(function(el) {
          el.classList.remove('active');
          if (el.classList.contains('dot') || el.classList.contains('dash')) {
            el.classList.add('played');
          }
        });
        finishPlayback(symElements);
      }
    }

    requestAnimationFrame(animate);

    // Timeout safety fallback
    const totalDuration = (currentTime - audioCtx.currentTime) * 1000 + 500;
    setTimeout(function() {
      if (isPlaying) finishPlayback(symElements);
    }, totalDuration);
  }

  function finishPlayback(symElements) {
    activeOscillators.forEach(function(o) { try { o.stop(); } catch(e) {} });
    activeOscillators = [];
    isPlaying = false;
    stopRequested = false;
    playBtn.classList.remove('playing');
    playIcon.innerHTML = '&#9654;';
    playLabel.textContent = 'play';
  }

  playBtn.addEventListener('click', playMorse);

  // --- Copy to clipboard ---
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(function() { toast.classList.remove('show'); }, 2000);
  }

  copyMorseBtn.addEventListener('click', function() {
    const text = morseInput.value.trim();
    if (!text) { showToast('nothing to copy'); return; }
    navigator.clipboard.writeText(text).then(function() {
      showToast('morse copied');
    }).catch(function() {
      showToast('copy failed');
    });
  });

  copyTextBtn.addEventListener('click', function() {
    const text = textInput.value.trim();
    if (!text) { showToast('nothing to copy'); return; }
    navigator.clipboard.writeText(text).then(function() {
      showToast('text copied');
    }).catch(function() {
      showToast('copy failed');
    });
  });

  // --- Reference chart ---
  function buildReferenceChart() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
    chars.forEach(function(ch) {
      const item = document.createElement('div');
      item.className = 'ref-item';
      const charSpan = document.createElement('span');
      charSpan.className = 'ref-char';
      charSpan.textContent = ch;
      const morseSpan = document.createElement('span');
      morseSpan.className = 'ref-morse';
      morseSpan.textContent = CHAR_TO_MORSE[ch];
      item.appendChild(charSpan);
      item.appendChild(morseSpan);
      refGrid.appendChild(item);
    });
  }

  refToggle.addEventListener('click', function() {
    const expanded = this.getAttribute('aria-expanded') === 'true';
    this.setAttribute('aria-expanded', String(!expanded));
    refGrid.classList.toggle('open');
  });

  buildReferenceChart();

  // Initial build
  buildPlaybackSymbols();
})();
</script>
</body>
</html>
